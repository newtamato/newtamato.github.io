
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>大富翁项目总结 - 番茄手册</title>
  <meta name="author" content="newtomato">

  
  <meta name="description" content="争分夺秒历时半年终于上线的项目进行回顾记录。">
  <meta name="keywords" content="cocos2dx+lua">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.newtomato.me/blog/2018/03/09/2017xiang-mu-zong-jie">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="番茄手册" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">think</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">番茄手册</a></h1>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.newtomato.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
   <li><a href="/about2">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">大富翁项目总结</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2018-03-09T17:53:10+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>年前1月份我们上线了一款大富翁游戏。他的玩法是传统的大富翁玩法+实时多人在线+陌生人匹配。这款游戏从立项到上线，设计思路变化过一次。小变化无数。历时半年左右。虽未取得大成功。但是对于我们团队而言，是一次很好的磨合历练。</p>

<p>之所以采用实时socket连接，就是希望玩家能够真实的感受有人在和他一起玩。希望通过玩家产生内容。增加黏性。提到socket实时游戏，常见的比如魔兽世界，王者荣耀以及绝地求生等（他们使用的实时技术是帧同步或者状态同步，均比我们自己项目中的同步要复杂的多，大富翁的规则是每个回合只有一个人才能够摇筛子，因此需要数据量相对轻量级）。如果大家怎么更好的实时同步感兴趣，建议去腾讯学院查找些干货，这里就不展开说了。</p>

<p>我这里主要总结项目的架构和遇到的问题。<br />
<!--more--></p>

<h2 id="section">概要介绍</h2>

<p>大富翁有很多系统杂糅一起。基础系统是土地买卖，更新归属权。玩家金钱，玩家状态变化。其他系统，股票系统，神仙系统，新闻命运等道路事件系统都是通过影响基础系统来增加玩法的趣味性。所以当玩家摇筛子走到一块没有任何归属土地的时候，需要判断很多情况。</p>

<ul>
  <li>是否有足够的金币。有，准备数据告诉服务器可以购买。（A数据包）</li>
  <li>否，是否有土地公。有，准备数据告诉服务器，我有土地公加成。（A数据包）</li>
  <li>有无恶狗等土地事件。有，准备数据，告诉服务器，恶狗附身。（B数据包）</li>
</ul>

<p>上述简单分析，也就是在这个WaitHere的逻辑中，我们需要调用Player模块，神仙模块，以及道路事件模块，最终将分析出的结果A，B包发给服务器。</p>

<p>在我们的逻辑中，数据模块是耦合在一起的（数据模块自身有对应的接口测试）。而对应逻辑模块自身会通过我们下面提到的自动化测试来验证正确性。</p>

<p>使用的模式有，观察者模式，代理模式，单例模式，状态模式等。使用MVC的思想对业务进行分离。</p>

<h2 id="section-1">请求响应同步模块</h2>

<p>把大富翁的客户端看成一个黑盒子，只有输入输出的话。输出是发出去的请求Request。输入是来自服务器的响应Response。</p>

<p>输出是将玩家的操作整理成请求数据。这个模块暂称之为<strong>“玩家操作模块”</strong>例如摇筛子，购地，升级，使用卡片等。<strong>“响应模块”</strong>就是处理请求，将“决定之后的结果”同步给所有玩家。摇出筛子数字，决定了购地，地块归属发生了变化等。这部分采用状态模式，根据服务器发来的不同状态，进入不同模块，更新数据，更新显示。</p>

<p>这样做的好处在于，数据最终都是以服务器为准。（客户端也会保存一份数据，用于展示。）请求出现问题，在服务器那边会进行校验判定。然后以错误码的形式发送过来。</p>

<p>服务器的响应一个同步队列。比如既能够土地归属发生变化（状态101+数据），又能让神仙附身（状态102+数据）等等。此处便采用状态模式。每种状态处理器各自分开互不影响。状态处理器挨个存到队列中，一个执行结束，执行下一个。知道全都执行结束。然后通知游戏，此次同步结束。解冻“玩家操作模块”，允许玩家继续操作游戏。另外每个状态处理还可以定制自己需要的参数。和服务器开发同学将协议商定下来就行。</p>

<h2 id="section-2">寻路模块</h2>

<p>大富翁类型的地图有自己的特殊性。首先地图有顺时针逆时针的方向要求。有多条主路和部分支路的区分。每条主路会成为一个闭环。玩家不能主动进入支路，只能被动进入。所以对策划同学给的地图我们需要按照顺时针方向制作号码标记。1，2，3，4等。在主路分叉路口上增加协议，例如2_main_1_1,2_main_1_2,2_main_1_3,…主路第一条岔路从主路编号2开始，2_main_2_1，2_main_2_2，2_main_2_3,…这是主路的第二条岔路也是主路编号2开始。说明在主路2号这里有两条岔路。<br />
至于分支，将main改为branch。<br />
按照这样的协议，就可以通过深度优先算法，求算出一条主路的路径。<br />
<img src="http://7xuepc.com1.z0.glb.clouddn.com/2018-03-09-15201639745417.jpg" alt="=w300" /></p>

<h2 id="section-3">断线重连模块</h2>

<p>由于网络环境的问题，游戏会经常断线。但是实际房间并未销毁。所以当玩家重新进入游戏。理论上应该可以重新加入游戏。<br />
此时最大的问题，就是玩家进入游戏需要初始游戏，但是此刻服务器有可能已经开始又数据发送多个更新包过来。所以此刻并不能够立马开始更新游戏。因此这些数据先暂存起来等待初始化完成在更新游戏。</p>

<p>这样数据不会丢失。但是如果缓存的数据过多，又会在更新的时候，造成播放时间较长。伤害了用户体验。因此这里可以将缓存数据做“压缩”处理。直接整合数据，将最后结果更新出来就行，而不用挨个更新。</p>

<p>断线重连遇到一个棘手的问题:<br />
玩家ABCD正处于某一个第三方模块中。模块的初始化时机在进入模块开始。离开模块的时候做清理操作。<br />
此时，某个玩家C突然掉线，待他断线重进的时候，这个第三方模块并未结束。但是服务器不在派发C的进入通知，导致C客户端并不会初始化模块的事件监听。于是游戏模块内做的数据更新通知，在C断线重连之后都不会再做。导致C的数据和其他玩家数据不一致。<br />
为此，只能讲第三方模块所需要用到的初始化都放在主模块中。</p>

<h2 id="section-4">自动测试模块</h2>

<p>这里的自动测试是通过对输入模块进行封装。原先由于用户决定的点击转成系统随机选择。<br />
对任何地块，均可有对应的决策。例如：<br />
	空地。他的决策是是否购地。<br />
	不是自己的土地，但是有归属，则决策是缴纳过路费。<br />
	是自己的土地，决策就是是否升级。<br />
	是自己的研究所，决策是是否要开始研究卡片。<br />
	不是自己的土地，但是身上有土地公。决策就是先付过路费，在占领别人的土地。<br />
以上的例子，均可证明自动测试中，决策可以有系统来做。一旦明确如此，就可以配置测试。</p>

<p>所以流程就是：摇筛子，寻目标地，然后进行决策。更新结果，继续摇筛子，如此循环往复。<br />
这种方式帮助我们测试功能模块是否正确。也节省了大量的测试工作。</p>

<h2 id="section-5">遇到的问题</h2>

<p>大富翁看似简单，实际上在开发中，我们遇到了不少问题。举几个例子：</p>

<ul>
  <li>玩家状态切换，在线和离线状态切换。</li>
  <li>控制权切换，以及在A控制关卡的同时，使用了陷害卡导致B触发了被动卡操作，A的操作倒计时停止，且不能操作关卡，B开始操作倒计时。直到B选择了结果，A的操作倒计时才继续。</li>
  <li>玩家断线重连。这里包括玩家自己杀死游戏重新进入。也包括玩家压入后台，在进入游戏之后，游戏session失效，重新自动登录。两种情况不同在于，第一种是开启了新的游戏进程。第二种是在当前游戏进程，需要清空数据和事件。</li>
  <li>闭包函数当中的upvalue属性要注意。</li>
  <li>场景资源在制作的时候，关卡宽高大约4000x3000，如果使用RGBA8888加载，大约内存会暴涨48M以上。为了能够在低端机上加载进来。所以裁成4张图，逐帧加载。采用pvr(ios)和pkm(android)来分别加载。会有明显改观。</li>
  <li>背景静态图片会带来内存带来压力。而建筑和玩家形象。使用骨骼动画制作，他们带来CPU的压力。初期测试，fps均值在30以上。但是卡顿的感受也存在。为此将建筑替换成序列帧动画。但是为此增加了包体。同屏的顶点数和drawcall有降低。</li>
  <li>美术资源维护出现问题，造成cocos动画工程丢失。只剩下导出文件。为此专门写了一个工具。用于将cocos工程还原。并支持序列帧的导出（部分导出有bug，以后改进。）。但是只能在手机上运行。电脑上总是出现黑边。使用的cocos3.6版本。未深入研究原因。</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">newtomato</span></span>

      








  


<time datetime="2018-03-09T17:53:10+08:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cocos2dx/'>cocos2dx</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.newtomato.me/blog/2018/03/09/2017xiang-mu-zong-jie" data-via="" data-counturl="http://www.newtomato.me/blog/2018/03/09/2017xiang-mu-zong-jie" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2018/02/11/unity-transform-tex" title="Previous Post: Unity Shader基础函数：TRANSFORM_TEX">&laquo; Unity Shader基础函数：TRANSFORM_TEX</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2018/05/07/androidshi-yong-dumpsysdao-chu-fps" title="Next Post: 补充在android如何使用dumpsys导出FPS">补充在android如何使用dumpsys导出FPS &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/05/19/godot-transform-1">Godot基础知识之Transform坐标转换</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/17/bugji-lu">记一个华为手机上声音突然消失不见的bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/13/tableviewcelldong-tai-kuan-gao">如何使用tableView制作一个高度可以变化的列表</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/07/androidshi-yong-dumpsysdao-chu-fps">补充在android如何使用dumpsys导出FPS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/09/2017xiang-mu-zong-jie">大富翁项目总结</a>
      </li>
    
  </ul>
</section>
<section>
 <h1>Categories</h1>
 <ul id="categories">
  <li class='category'><a href='/blog/categories/2d/'>2d (2)</a></li>
<li class='category'><a href='/blog/categories/ads/'>ads (1)</a></li>
<li class='category'><a href='/blog/categories/android/'>android (7)</a></li>
<li class='category'><a href='/blog/categories/androidstudio/'>androidstudio (1)</a></li>
<li class='category'><a href='/blog/categories/android开发/'>android开发 (1)</a></li>
<li class='category'><a href='/blog/categories/apache/'>apache (1)</a></li>
<li class='category'><a href='/blog/categories/apk/'>apk (1)</a></li>
<li class='category'><a href='/blog/categories/atom/'>atom (1)</a></li>
<li class='category'><a href='/blog/categories/basic/'>basic (2)</a></li>
<li class='category'><a href='/blog/categories/blend/'>blend (1)</a></li>
<li class='category'><a href='/blog/categories/bm-subtract/'>bm_subtract (1)</a></li>
<li class='category'><a href='/blog/categories/box2d/'>box2d (2)</a></li>
<li class='category'><a href='/blog/categories/bug/'>bug (1)</a></li>
<li class='category'><a href='/blog/categories/c-/'>c# (1)</a></li>
<li class='category'><a href='/blog/categories/c-/'>c++ (4)</a></li>
<li class='category'><a href='/blog/categories/ccfileutil/'>ccfileutil (1)</a></li>
<li class='category'><a href='/blog/categories/cocos2d-x/'>cocos2d-x (1)</a></li>
<li class='category'><a href='/blog/categories/cocos2dx/'>cocos2dx (8)</a></li>
<li class='category'><a href='/blog/categories/cocos2dx骨骼动画换装/'>cocos2dx骨骼动画换装 (1)</a></li>
<li class='category'><a href='/blog/categories/djnago-blog-zinnia/'>djnago-blog-zinnia (1)</a></li>
<li class='category'><a href='/blog/categories/dns64/'>dns64 (1)</a></li>
<li class='category'><a href='/blog/categories/facebook/'>facebook (1)</a></li>
<li class='category'><a href='/blog/categories/flavors/'>flavors (1)</a></li>
<li class='category'><a href='/blog/categories/game/'>game (2)</a></li>
<li class='category'><a href='/blog/categories/gdscript/'>gdscript (1)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (5)</a></li>
<li class='category'><a href='/blog/categories/godot/'>godot (2)</a></li>
<li class='category'><a href='/blog/categories/google/'>google (2)</a></li>
<li class='category'><a href='/blog/categories/gradle/'>gradle (1)</a></li>
<li class='category'><a href='/blog/categories/iap/'>iap (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (2)</a></li>
<li class='category'><a href='/blog/categories/ipv6/'>ipv6 (1)</a></li>
<li class='category'><a href='/blog/categories/java/'>java (1)</a></li>
<li class='category'><a href='/blog/categories/jekins/'>jekins (1)</a></li>
<li class='category'><a href='/blog/categories/jni/'>jni (1)</a></li>
<li class='category'><a href='/blog/categories/keystore/'>keystore (1)</a></li>
<li class='category'><a href='/blog/categories/keytool/'>keytool (1)</a></li>
<li class='category'><a href='/blog/categories/limbo/'>limbo (1)</a></li>
<li class='category'><a href='/blog/categories/linter-luacheck/'>linter-luacheck (1)</a></li>
<li class='category'><a href='/blog/categories/liquidfunc/'>liquidfunc (1)</a></li>
<li class='category'><a href='/blog/categories/log/'>log (1)</a></li>
<li class='category'><a href='/blog/categories/lua/'>lua (9)</a></li>
<li class='category'><a href='/blog/categories/luabing/'>luabing (2)</a></li>
<li class='category'><a href='/blog/categories/luacheck/'>luacheck (1)</a></li>
<li class='category'><a href='/blog/categories/mac/'>mac (2)</a></li>
<li class='category'><a href='/blog/categories/maker/'>maker (2)</a></li>
<li class='category'><a href='/blog/categories/mobile/'>mobile (1)</a></li>
<li class='category'><a href='/blog/categories/mode/'>mode (1)</a></li>
<li class='category'><a href='/blog/categories/obb/'>obb (2)</a></li>
<li class='category'><a href='/blog/categories/opengl/'>opengl (7)</a></li>
<li class='category'><a href='/blog/categories/platform/'>platform (1)</a></li>
<li class='category'><a href='/blog/categories/profiles/'>profiles (2)</a></li>
<li class='category'><a href='/blog/categories/provision/'>provision (2)</a></li>
<li class='category'><a href='/blog/categories/python/'>python (3)</a></li>
<li class='category'><a href='/blog/categories/quaternion/'>quaternion (1)</a></li>
<li class='category'><a href='/blog/categories/rebase/'>rebase (1)</a></li>
<li class='category'><a href='/blog/categories/require/'>require (1)</a></li>
<li class='category'><a href='/blog/categories/restapi/'>restapi (1)</a></li>
<li class='category'><a href='/blog/categories/serpent/'>serpent (1)</a></li>
<li class='category'><a href='/blog/categories/shell/'>shell (1)</a></li>
<li class='category'><a href='/blog/categories/sqlite3/'>sqlite3 (1)</a></li>
<li class='category'><a href='/blog/categories/stickerpack/'>stickerpack (1)</a></li>
<li class='category'><a href='/blog/categories/sublime/'>sublime (1)</a></li>
<li class='category'><a href='/blog/categories/svn/'>svn (1)</a></li>
<li class='category'><a href='/blog/categories/table/'>table (1)</a></li>
<li class='category'><a href='/blog/categories/tolua-/'>tolua++ (1)</a></li>
<li class='category'><a href='/blog/categories/typecho/'>typecho (1)</a></li>
<li class='category'><a href='/blog/categories/unity/'>unity (2)</a></li>
<li class='category'><a href='/blog/categories/unity2d/'>unity2d (1)</a></li>
<li class='category'><a href='/blog/categories/vector3/'>vector3 (1)</a></li>
<li class='category'><a href='/blog/categories/vim/'>vim (1)</a></li>
<li class='category'><a href='/blog/categories/wwdr/'>wwdr (1)</a></li>
<li class='category'><a href='/blog/categories/xcode/'>xcode (1)</a></li>
<li class='category'><a href='/blog/categories/个人网站/'>个人网站 (1)</a></li>
<li class='category'><a href='/blog/categories/人物控制移动/'>人物控制移动 (1)</a></li>
<li class='category'><a href='/blog/categories/冒泡/'>冒泡 (1)</a></li>
<li class='category'><a href='/blog/categories/加密/'>加密 (1)</a></li>
<li class='category'><a href='/blog/categories/动画工具/'>动画工具 (1)</a></li>
<li class='category'><a href='/blog/categories/命令行/'>命令行 (1)</a></li>
<li class='category'><a href='/blog/categories/工作/'>工作 (2)</a></li>
<li class='category'><a href='/blog/categories/快速/'>快速 (1)</a></li>
<li class='category'><a href='/blog/categories/思维发散/'>思维发散 (1)</a></li>
<li class='category'><a href='/blog/categories/总结/'>总结 (1)</a></li>
<li class='category'><a href='/blog/categories/排序/'>排序 (1)</a></li>
<li class='category'><a href='/blog/categories/提交大包/'>提交大包 (1)</a></li>
<li class='category'><a href='/blog/categories/插入/'>插入 (1)</a></li>
<li class='category'><a href='/blog/categories/改进/'>改进 (1)</a></li>
<li class='category'><a href='/blog/categories/效率/'>效率 (1)</a></li>
<li class='category'><a href='/blog/categories/模块化/'>模块化 (1)</a></li>
<li class='category'><a href='/blog/categories/模拟器/'>模拟器 (1)</a></li>
<li class='category'><a href='/blog/categories/游戏/'>游戏 (2)</a></li>
<li class='category'><a href='/blog/categories/游戏引擎/'>游戏引擎 (1)</a></li>
<li class='category'><a href='/blog/categories/游戏测试/'>游戏测试 (1)</a></li>
<li class='category'><a href='/blog/categories/漫威/'>漫威 (1)</a></li>
<li class='category'><a href='/blog/categories/热更/'>热更 (1)</a></li>
<li class='category'><a href='/blog/categories/神秘海域4/'>神秘海域4 (1)</a></li>
<li class='category'><a href='/blog/categories/第三方接入/'>第三方接入 (2)</a></li>
<li class='category'><a href='/blog/categories/算法/'>算法 (1)</a></li>
<li class='category'><a href='/blog/categories/管理总结/'>管理总结 (1)</a></li>
<li class='category'><a href='/blog/categories/管理-沟通/'>管理，沟通 (1)</a></li>
<li class='category'><a href='/blog/categories/胡思乱想/'>胡思乱想 (1)</a></li>
<li class='category'><a href='/blog/categories/脚本/'>脚本 (1)</a></li>
<li class='category'><a href='/blog/categories/自动化/'>自动化 (1)</a></li>
<li class='category'><a href='/blog/categories/自动化测试/'>自动化测试 (1)</a></li>
<li class='category'><a href='/blog/categories/自动更新/'>自动更新 (1)</a></li>
<li class='category'><a href='/blog/categories/苹果审核被拒/'>苹果审核被拒 (1)</a></li>
<li class='category'><a href='/blog/categories/选择/'>选择 (1)</a></li>
<li class='category'><a href='/blog/categories/问题/'>问题 (1)</a></li>
<li class='category'><a href='/blog/categories/项目/'>项目 (2)</a></li>
<li class='category'><a href='/blog/categories/项目管理/'>项目管理 (1)</a></li>
<li class='category'><a href='/blog/categories/顽皮狗/'>顽皮狗 (2)</a></li>

 </ul>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - newtomato -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
