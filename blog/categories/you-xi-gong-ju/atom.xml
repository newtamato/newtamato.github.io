<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[分类:游戏工具 | 番茄手册]]></title>
  <link href="http://www.newtomato.me/blog/categories/you-xi-gong-ju/atom.xml" rel="self"/>
  <link href="http://www.newtomato.me/"/>
  <updated>2019-01-06T14:55:28+08:00</updated>
  <id>http://www.newtomato.me/</id>
  <author>
    <name><![CDATA[newtomato]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[500人同时在线的客户端小工具]]></title>
    <link href="http://www.newtomato.me/blog/2019/01/05/010"/>
    <updated>2019-01-05T17:58:54+08:00</updated>
    <id>http://www.newtomato.me/blog/2019/01/05/010</id>
    <content type="html"><![CDATA[<h2 id="section">背景说明</h2>

<p>前段时间为服务器端压力和代码质量测试做了一个小小的贡献。<br />
这个工具不复杂，却能解决大问题。我借此想要抛砖引玉，希望大家在开发中不要将思路仅仅局限在某个方面，应该拓展视野，发现更多。</p>

<p>一般情况下，服务器上线前，会自己做这方面的测试。而我们的情况还真是特殊。服务器自己用机器人上去跑，没有爆出错误。而我们的用户自己登陆游戏，做些操作，就莫名的出现了问题。尤其是同时在线的人数并不多，有的时候不到100人就爆了。</p>

<p>于是我们怀疑服务器端的机器人逻辑和玩家自己的逻辑可能不一样。由于服务器那边很多代码，都是陈年老酒了。改也改不动。于是我们转换思路，就用大量客户端发起请求测试。</p>

<p>这里的“大量”是同时在线500人。虽不多，但也足以测试出问题。<br />
<!--more--><br />
## 问题</p>

<p>问题是一个客户端如何做到同时在线500人？</p>

<h2 id="section-1">动手之前的思考</h2>

<p>以我们底层的架构，玩家需要连接3个socket才能正常操作游戏，并且这三个socket都活着。所以同时500人，实际上就是1500个socket。<br />
正常操作是直接创建1500个socket吧（先不管他是不是卡的要死），虽然都能创建成功，但只有64个有效。为何呢？因为而windows默认socket同时存在的数量是64个！<br />
我修改了这个配置，写成了2048，理论上可以支持超过500人。<br />
只是超过500人，会让我的windows电脑卡的不成样子。</p>

<p>剩下的事，就是抽逻辑。<br />
相信大家都写过一些工具，比如在UI还没有给的时候，我们自己写逻辑，然后测试一下，美术那边提供了之后，我们在替换进去。<br />
因此没有UI的那些逻辑才是项目的核心。<br />
<code>login -&gt; start_game -&gt; buy_something</code></p>

<p>##动手做吧</p>

<p>前面想清楚了，我们在来把客户端大卸八块。首先去掉所有的View（游戏里面View的渲染也是性能消耗的大部头）。核心的网络库部分抽取出来，扩展一下支持多个玩家。游戏里面请求部分抽取出来（这块如果在开发中能够做到独立于view，那么做起来真是相当方便。如果耦合到view中，你懂得。）</p>

<p>工具做出来之后，大量的请求发过去，给服务器极大的压力，即测试同时在线的能力，又测试服务器代码的质量。后期增加新的请求，也都会更新到这来。每天都要跑一跑，有问题也能提早发现。</p>

<p>理论是如此，但是你可定要问了，那么多请求，有些是在特定场景下触发的啊，你怎么做到自动的？或者是，我游戏还有压后台，进前台操作。还有网络不好，断线重连进入游戏呢？都怎么做？</p>

<p>你对一个玩家是怎么做到的，那么就能明白如何管理500个玩家了。</p>

<p>脱离UI写游戏，才能看清这背后的道理。对不对?</p>

<h2 id="section-2">问题来了？</h2>

<p>超过1000人，怎么做？<br />
哎呀，你有什么办法？</p>

]]></content>
  </entry>
  
</feed>
