
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setfenv有何用？ - 番茄手册</title>
  <meta name="author" content="newtomato">

  
  <meta name="description" content="上一章，我们提到了模块里面的函数，使用点语法的方式定义函数和变量。点之前的名字类似一个命名空间。比如function A.function() end,此处A就相当于一个命名空间，那么我们能不能有更好地方法不用写这个命名空间呢？当然是可以的。lua提供这样的方式。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.newtomato.me/blog/2015/11/18/lua-setfenv">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="番茄手册" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-70121917-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">番茄手册</a></h1>
  
    <h2>西红柿炒鸡蛋</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Setfenv有何用？</h1>
    
    
      <p class="meta">
        








  



<time datetime="2015-11-18T00:39:31+08:00" pubdate data-updated="true">2015 年11 月18 日</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>上一章，我们提到了模块里面的函数，使用点语法的方式定义函数和变量。点之前的名字类似一个命名空间。比如<code>function A.function() end</code>,此处A就相当于一个命名空间，那么我们能不能有更好地方法不用写这个命名空间呢？当然是可以的。lua提供这样的方式。</p>

<!--more-->

<p>这个方法涉及到一个核心函数<code>setfenv()</code>, 我们看一下这个函数的API：<br />
setfenv(f, table)：设置一个函数的环境<br />
1. 当第一个参数为一个函数时，表示设置该函数的环境<br />
2. 当第一个参数为一个数字时，为1代表当前函数，2代表调用自己的函数，3代表调用自己的函数的函数，以此类推</p>

<p>看第一条，他说到可以设置函数的环境。如果我们不调用setfenv，那么函数的环境是什么呢？其实就是默认的_G.所有已经加载了函数变量模块都会被注册到_G中，因此我们可以在B.lua文件中直接调用A.lua中定义的USER_NAME就不会报错。</p>

<p>但是如果我们调用了setfenv()，会发生什么事情？我们来试试。<br />
A.lua</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">USER_NAME = "jolie"
</span><span class="line">ITEM_NAME = "abc"
</span><span class="line">ITEM_COUNT = 123</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>调用函数：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">require("A")
</span><span class="line">setfenv(1,{})
</span><span class="line">tostring(USER_NAME)
</span><span class="line">print("i want to print user name")</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>结果会是什么样子的呢？<br />
结果就是tostring，print无法被调用，咦？这是怎么回事呢？其实很简单，原来tostring和print很早就被注册到了_G中，我们把函数环境设成了空表，于是再也找不到了tostring和print了。这就报错了！</p>

<p>因此既然我们用得到print和tostring，我们就把这两个函数保存起来，传递给我们当前的函数环境。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">setfenv(1,{print = _G["print"],tostring = _G["tostring"]})</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>再次运行，发现了没有，没有报错。正确打印了。<br />
但是这样会不会因此影响到其他的模块呢？比如有一个B.lua，他是否能够正确执行？</p>

<p>A.lua</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class=""><span class="line">local A = {print = _G["print"],tostring = _G["tostring"]}
</span><span class="line">setfenv(1,A)
</span><span class="line">-- setfenv(1,{})
</span><span class="line">name = "hello,A"
</span><span class="line">function doA( ... )
</span><span class="line">	print("i am A, i call doA function")
</span><span class="line">end
</span><span class="line">
</span><span class="line">function doA2( ... )
</span><span class="line">	print("i am doA2, i call doA2 function")
</span><span class="line">end
</span><span class="line">
</span><span class="line">return A</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>B.lua</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class=""><span class="line">local B = {}
</span><span class="line">function B.doAction()
</span><span class="line">	local a = {}
</span><span class="line">	table.insert(a,1)
</span><span class="line">	table.insert(a,2)
</span><span class="line">	table.insert(a,3)
</span><span class="line">	for k,v in pairs(a) do
</span><span class="line">		print(k,v)
</span><span class="line">	end
</span><span class="line">end
</span><span class="line">return B</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>调用代码：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">a = require("A")
</span><span class="line">a.doA()
</span><span class="line">a.doA2()
</span><span class="line">print("i want to print user name , "..a.name)
</span><span class="line">b = require("B")
</span><span class="line">b.doAction()</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>看见打印了么？没错！我们设置了A的函数环境，但是并没有因此而影响到B和调用的地方。这说明setfenv只是对当前的模块函数环境进行了设置，而并没有影响到其他。这就是setfenv第一个参数的作用，它指定了当前函数，而不是全局函数，因此只对A这个当前的函数模块进行了设置。</p>

<p>setfenv()还有什么特别的用处？敬请等待下回分析！</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">newtomato</span></span>

      








  



<time datetime="2015-11-18T00:39:31+08:00" pubdate data-updated="true">2015 年11 月18 日</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/lua/'>lua</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.newtomato.me/blog/2015/11/18/lua-setfenv" data-via="" data-counturl="http://www.newtomato.me/blog/2015/11/18/lua-setfenv" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/11/15/serpent-for-lua" title="Previous Post: Serpent：lua序列化和pretty的输出">&laquo; Serpent：lua序列化和pretty的输出</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/11/22/cocos2dx-dragebones-huan-zhuang" title="Next Post: cocos2dx如果实现骨骼动画的换装">cocos2dx如果实现骨骼动画的换装 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

  <aside class="sidebar">
   
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.newtomato.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/11/29/dev-certification-provision2">Certificate与provision Profiles 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/29/dev-certification-provision1">Certificate与provision Profiles</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/29/the-last-of-us-story">The Last of Us 故事板</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/22/git-remove-branch-remotely">Git如何在本地和远端都删除相关的分支</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/22/cocos2dx-dragebones-huan-zhuang">Cocos2dx如果实现骨骼动画的换装</a>
      </li>
    
  </ul>
</section>
<section>
 <h1>Categories</h1>
 <ul id="categories">
  <li class='category'><a href='/blog/categories/android开发/'>android开发 (1)</a></li>
<li class='category'><a href='/blog/categories/basic/'>basic (2)</a></li>
<li class='category'><a href='/blog/categories/c-/'>c++ (3)</a></li>
<li class='category'><a href='/blog/categories/cocos2dx骨骼动画换装/'>cocos2dx骨骼动画换装 (1)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (4)</a></li>
<li class='category'><a href='/blog/categories/log/'>log (1)</a></li>
<li class='category'><a href='/blog/categories/lua/'>lua (7)</a></li>
<li class='category'><a href='/blog/categories/profiles/'>profiles (2)</a></li>
<li class='category'><a href='/blog/categories/provision/'>provision (2)</a></li>
<li class='category'><a href='/blog/categories/rebase/'>rebase (1)</a></li>
<li class='category'><a href='/blog/categories/serpent/'>serpent (1)</a></li>
<li class='category'><a href='/blog/categories/vim/'>vim (1)</a></li>
<li class='category'><a href='/blog/categories/命令行/'>命令行 (1)</a></li>
<li class='category'><a href='/blog/categories/游戏/'>游戏 (1)</a></li>
<li class='category'><a href='/blog/categories/管理总结/'>管理总结 (1)</a></li>
<li class='category'><a href='/blog/categories/管理-沟通/'>管理，沟通 (1)</a></li>

 </ul>
</section>




  
</aside>



    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - newtomato -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>
  $(document).ready(function() {  
    var stickyNavTop = $('nav').offset().top;  
      
    var stickyNav = function(){  
      var scrollTop = $(window).scrollTop(); 
      var navHasClassSticky = $('nav').hasClass('sticky');

      if (scrollTop > stickyNavTop && navHasClassSticky) {   
        return true;
      } else if (scrollTop > stickyNavTop) {
        $('nav').hide();
        $('nav').addClass('sticky');
        $('nav').fadeIn('2000');
      } else {  
        $('nav').removeClass('sticky');   
      }  
    };  
      
    stickyNav();  
      
    $(window).scroll(function() {  
      stickyNav();  
    });  
  });  
</script>


</body>
</html>
