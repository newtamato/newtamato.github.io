
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>Lua脚本在C++下的舞步（三）  | 番茄手册</title>

<meta name="author" content="newtomato"> 

<meta name="description" content="转帖来自：http://www.acejoy.com/bbs/viewthread.php?tid=1931&amp;extra=page%3D1 上一讲我把Lua基本的栈规则讲了一下，然后完善了一下我的CLuaFn类。让它可以支持任意参数数量和函数名称的传值。当然， &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="番茄手册" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">番茄手册</a></h1>
<h4></h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/about">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/about">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:www.newtomato.me">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Lua脚本在C++下的舞步（三）</h2>
	<div class="entry-content"><p>转帖来自：http://www.acejoy.com/bbs/viewthread.php?tid=1931&amp;extra=page%3D1</p>

<p>上一讲我把Lua基本的栈规则讲了一下，然后完善了一下我的CLuaFn类。让它可以支持任意参数数量和函数名称的传值。当然，这些功能是为了今天这篇文章而铺路的。</p>

<p>看了七猫的回帖，呵呵，确实应该说一下SWIG这个工具，说真的，我对这个工具理解不深，因为没有怎么用过，读过一些关于它的文章，似乎是帮你把C++的功能封装成一个Lua基本库的东西，但是后来研究，他可以很轻松帮你把公用函数封装成一个Lua的基本库(类似C++的dll)，但是对于我的需求而言，可能不太一样。因为我大量的是需要在C++里面进行数据传输以及变量的交互，所以为了紧贴C++，我需要很多关联数据的处理。 <br />
我是一名C++程序员，所以在很多时候，不想过多的使用Lua的特性，因为个人感觉，Lua的语法要比C++的更加灵活。而我更希望，在函数调用的某些习惯上，遵循一些C++的规则。</p>

<!--more-->

<p>好了，废话少说，我们先来看一个类（头文件）。假设我们要把这个对象，传输给Lua进行调用。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#ifndef _TEST_H 
</span><span class="line">#define _TEST_H
</span><span class="line">class CTest 
</span><span class="line">{ 
</span><span class="line">public: 
</span><span class="line">        CTest(void); 
</span><span class="line">        ~CTest(void);
</span><span class="line">        char* GetData(); 
</span><span class="line">        void SetData(const char* pData);
</span><span class="line">private: 
</span><span class="line">        char m_szData[200]; 
</span><span class="line">}; 
</span><span class="line">#endif</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这个类里面有两个函数，一个是GetData()，一个是SetData()，之所以这么写，我要让Lua不仅能使用我的类，还可以给这个类使用参数。 <br />
那么，cpp文件，我们姑且这样写。（当然，你可以进行修改，按照你喜欢的方式写一个方法，呵呵）</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class=""><span class="line">char* CTest::GetData() 
</span><span class="line">{ 
</span><span class="line">        printf(“[CTest::GetData]%s./n”, m_szData); 
</span><span class="line">        return m_szData; 
</span><span class="line">}
</span><span class="line">
</span><span class="line">void CTest::SetData(const char* pData) 
</span><span class="line">{ 
</span><span class="line">        sprintf(m_szData, “%s”, pData); 
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这是一个标准的类，我需要这个类在Lua里面可以创造出来，并赋予数值，甚至我可以把CTest作为一个Lua函数参数，传给Lua函数让它去给我处理。让我们来看看怎么做。如果使用标准的Lua语法，有点多，所以我就借用一下上次提到的tolua来做到这一切，我一句句的解释。姑且我们把这些代码放在LuaFn.cpp里面。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="k">static</span> <span class="kt">int</span> <span class="nf">tolua_new_CTest</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">pState</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CTest</span><span class="p">();</span>
</span><span class="line">        <span class="n">tolua_pushusertype</span><span class="p">(</span><span class="n">pState</span><span class="p">,</span> <span class="n">pTest</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">int</span> <span class="nf">tolua_delete_CTest</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">pState</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTest</span> <span class="o">=</span> <span class="p">(</span><span class="n">CTest</span><span class="o">*</span> <span class="p">)</span><span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">pState</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">pTest</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">                <span class="k">delete</span> <span class="n">pTest</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">int</span> <span class="nf">tolua_SetData_CTest</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">pState</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTest</span> <span class="o">=</span> <span class="p">(</span><span class="n">CTest</span><span class="o">*</span> <span class="p">)</span><span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">pState</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pData</span> <span class="o">=</span> <span class="n">tolua_tostring</span><span class="p">(</span><span class="n">pState</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="n">pData</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pTest</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">                <span class="n">pTest</span><span class="o">-&gt;</span><span class="n">SetData</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">int</span> <span class="nf">tolua_GetData_CTest</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">pState</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTest</span> <span class="o">=</span> <span class="p">(</span><span class="n">CTest</span><span class="o">*</span> <span class="p">)</span><span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">pState</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="n">pTest</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">                <span class="kt">char</span><span class="o">*</span> <span class="n">pData</span> <span class="o">=</span> <span class="n">pTest</span><span class="o">-&gt;</span><span class="n">GetData</span><span class="p">();</span>
</span><span class="line">                <span class="n">tolua_pushstring</span><span class="p">(</span><span class="n">pState</span><span class="p">,</span> <span class="n">pData</span><span class="p">);</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>看看这几个静态函数在干什么。 <br />
我要在Lua里面使用CTest，必须让Lua里这个CTest对象能够顺利的创造和销毁。<code>tolua_new_CTest()</code>和<code>tolua_delete_CTest()</code>就是干这个的。 <br />
<code>tolua_pushusertype(pState, pTest, “CTest”);</code> 这句话的意思是，将一个已经在Lua注册的”CTest”对象指针，压入数据栈。 <br />
同理，<code>CTest* pTest = (CTest* )tolua_tousertype(pState, 1, 0);</code>是将数据栈下的对象以(CTest* )的指针形式弹出来。</p>

<p><code>tolua_SetData_CTest()</code>函数和<code>tolua_GetData_CTest</code>分别对应CTest的SetData方法和GetData()方法。因为我们的SetData方法里面存在变量，那么同样，我们需要使用<code>const char* pData = tolua_tostring(pState, 2, 0);</code>将参数弹出来，然后输入到<code>pTest-&gt;SetData(pData);</code>对象中去，当然，你可以有更多若干个参数。随你的喜好。这里只做一个举例。</p>

<p>好了，你一定会问，这么多的静态函数，用在哪里？呵呵，当然是给Lua注册，当你把这些数据注册到Lua里面，你就可以轻松的在Lua中使用它们。 <br />
让我们看看，注册是怎么做到的。</p>

<p>还是在CLuaFn类里面，我们增加一个函数。比如叫做bool InitClass();</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="kt">bool</span> <span class="n">CLuaFn</span><span class="o">::</span><span class="n">InitClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">m_pState</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">                <span class="n">printf</span><span class="p">(</span><span class="err">“</span><span class="p">[</span><span class="n">CLuaFn</span><span class="o">::</span><span class="n">InitClass</span><span class="p">]</span><span class="n">m_pState</span> <span class="n">is</span> <span class="nb">NULL</span><span class="p">.</span><span class="o">/</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="n">tolua_open</span><span class="p">(</span><span class="n">m_pState</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_module</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_beginmodule</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">tolua_usertype</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_cclass</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">,</span> <span class="err">“”</span><span class="p">,</span> <span class="n">tolua_delete_CTest</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">tolua_beginmodule</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_function</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="err">“</span><span class="k">new</span><span class="err">”</span><span class="p">,</span> <span class="n">tolua_new_CTest</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_function</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="err">“</span><span class="n">SetData</span><span class="err">”</span><span class="p">,</span> <span class="n">tolua_SetData_CTest</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_function</span><span class="p">(</span><span class="n">m_pState</span><span class="p">,</span> <span class="err">“</span><span class="n">GetData</span><span class="err">”</span><span class="p">,</span> <span class="n">tolua_GetData_CTest</span><span class="p">);</span>
</span><span class="line">        <span class="n">tolua_endmodule</span><span class="p">(</span><span class="n">m_pState</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">tolua_endmodule</span><span class="p">(</span><span class="n">m_pState</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>上面的代码，就是我把上面的几个静态函数，绑定到Lua的基础对象中去。 <br />
<code>tolua_beginmodule(m_pState, “CTest”);</code>是只注册一个模块，比如，我们管CTest叫做”CTest”，保持和C++的名称一样。这样在Lua的对象库中就会多了一个CTest的对象描述，等同于string,number等等基本类型，同理，你也可以用同样的方法，注册你的MFC类。是不是有点明白了？这里要注意，<code>tolua_beginmodule()</code>和<code>tolua_endmodule()</code>对象必须成对出现，如果出现不成对的，你注册的C++类型将会失败。 <br />
<code>tolua_function(m_pState, “SetData”, tolua_SetData_CTest);</code>指的是将Lua里面CTest对象的”SetData”绑定到你的<code>tolua_SetData_CTest()</code>函数中去。</p>

<p>好的，让我们来点激动人心的东西。还记得我们的Simple.lua的文件么。我们来改一下它。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="n">function</span> <span class="nf">func_Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class="line">  <span class="n">local</span> <span class="n">test</span> <span class="o">=</span> <span class="nl">CTest</span><span class="p">:</span><span class="k">new</span><span class="p">();</span>
</span><span class="line">  <span class="nl">test</span><span class="p">:</span><span class="n">SetData</span><span class="p">(</span><span class="err">“</span><span class="n">I</span><span class="err">’</span><span class="n">m</span> <span class="n">freeeyes</span><span class="o">!</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">  <span class="nl">test</span><span class="p">:</span><span class="n">GetData</span><span class="p">();</span>
</span><span class="line">  <span class="k">return</span> <span class="n">x</span><span class="p">..</span><span class="n">y</span><span class="p">;</span>
</span><span class="line"><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我在这个函数里面，New了一个CTest对象，并进行赋值操作，最后把结果打印在屏幕上。你或许会问，最后一句不是x+y么，怎么变成了x..y，呵呵，在Lua中，..表示联合的意思，就好比在C++里面， string strName += “freeeyes”。原来觉得x+y有点土，索性返回一个两个字符串的联合吧。</p>

<p>好了，我们已经把我们的这个CTest类注册到了Lua里面，让我们来调用一下吧。修改一下Main函数。变成以下的样子。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CLuaFn</span> <span class="n">LuaFn</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">InitClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">LoadLuaFile</span><span class="p">(</span><span class="err">“</span><span class="n">Sample</span><span class="p">.</span><span class="n">lua</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">CParamGroup</span> <span class="n">ParamIn</span><span class="p">;</span>
</span><span class="line">        <span class="n">CParamGroup</span> <span class="n">ParamOut</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span> <span class="n">szData1</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">sprintf</span><span class="p">(</span><span class="n">szData1</span><span class="p">,</span> <span class="err">“</span><span class="p">[</span><span class="n">freeeyes</span><span class="p">]</span><span class="err">“</span><span class="p">);</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData1</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">szData1</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam1</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span> <span class="n">szData2</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">sprintf</span><span class="p">(</span><span class="n">szData2</span><span class="p">,</span> <span class="err">“</span><span class="p">[</span><span class="n">shiqiang</span><span class="p">]</span><span class="err">“</span><span class="p">);</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData2</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">szData2</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam2</span><span class="p">);</span>
</span><span class="line">        <span class="kt">char</span> <span class="n">szData3</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData3</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span><span class="line">        <span class="n">ParamOut</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam3</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">CallFileFn</span><span class="p">(</span><span class="err">“</span><span class="n">func_Add</span><span class="err">”</span><span class="p">,</span> <span class="n">ParamIn</span><span class="p">,</span> <span class="n">ParamOut</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span><span class="o">*</span> <span class="n">pData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="p">)</span><span class="n">ParamOut</span><span class="p">.</span><span class="n">GetParam</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetParam</span><span class="p">();</span>
</span><span class="line">        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[Main]Sum = %s./n&quot;</span><span class="p">,</span> <span class="n">pData</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">getchar</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>如果你完全按照我的，你就可以编译你的工程了，运行一下，看看是啥结果？</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="p">[</span><span class="n">CTest</span><span class="o">::</span><span class="n">GetData</span><span class="p">]</span><span class="n">I</span><span class="err">’</span><span class="n">m</span> <span class="n">freeeyes</span><span class="o">!</span><span class="p">.</span>
</span><span class="line"><span class="p">[</span><span class="n">Main</span><span class="p">]</span><span class="n">Sum</span> <span class="o">=</span> <span class="p">[</span><span class="n">freeeyes</span><span class="p">][</span><span class="n">shiqiang</span><span class="p">].</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>看看，是不是和我输出的一样？<br />
呵呵，有意思吧，你已经可以在Lua里面用C++的函数了，那么咱们再增加一点难度，比如，我有一个CTest对象，要作为一个参数，传输给func_Add()执行，怎么办？ <br />
很简单，如果你对上面的代码仔细阅读，你会发现下面的代码一样简洁。为了支持刚才要说的需求，我们需要把Sample.lua再做一点修改。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="n">function</span> <span class="nf">func_Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span class="line">  <span class="nl">f</span><span class="p">:</span><span class="n">SetData</span><span class="p">(</span><span class="err">“</span><span class="n">I</span><span class="err">’</span><span class="n">m</span> <span class="n">freeeyes</span><span class="o">!</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">  <span class="nl">f</span><span class="p">:</span><span class="n">GetData</span><span class="p">();</span>
</span><span class="line">  <span class="k">return</span> <span class="n">x</span><span class="p">..</span><span class="n">y</span><span class="p">;</span>
</span><span class="line"><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>f假设就是我们要传入的CTest对象。我们要在Lua里面使用它。（我们的CLuaFn都不用改，把main函数稍微改一下即可，来看看怎么写。）</p>

<p>LuaSample.cpp : 定义控制台应用程序的入口点。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="cp">#include “stdafx.h” </span>
</span><span class="line"><span class="cp">#include “LuaFn.h”</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CLuaFn</span> <span class="n">LuaFn</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">InitClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">LoadLuaFile</span><span class="p">(</span><span class="err">“</span><span class="n">Sample</span><span class="p">.</span><span class="n">lua</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">CParamGroup</span> <span class="n">ParamIn</span><span class="p">;</span>
</span><span class="line">        <span class="n">CParamGroup</span> <span class="n">ParamOut</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span> <span class="n">szData1</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">sprintf</span><span class="p">(</span><span class="n">szData1</span><span class="p">,</span> <span class="err">“</span><span class="p">[</span><span class="n">freeeyes</span><span class="p">]</span><span class="err">“</span><span class="p">);</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData1</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">szData1</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam1</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span> <span class="n">szData2</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">sprintf</span><span class="p">(</span><span class="n">szData2</span><span class="p">,</span> <span class="err">“</span><span class="p">[</span><span class="n">shiqiang</span><span class="p">]</span><span class="err">“</span><span class="p">);</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData2</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">szData2</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam2</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="c1">//只追加了这里 </span>
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CTest</span><span class="p">();</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">pTest</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CTest</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam3</span><span class="p">);</span>
</span><span class="line">       <span class="c1">//追加结束 </span>
</span><span class="line">        <span class="kt">char</span> <span class="n">szData4</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData4</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span><span class="line">        <span class="n">ParamOut</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam4</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">CallFileFn</span><span class="p">(</span><span class="err">“</span><span class="n">func_Add</span><span class="err">”</span><span class="p">,</span> <span class="n">ParamIn</span><span class="p">,</span> <span class="n">ParamOut</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span><span class="o">*</span> <span class="n">pData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="p">)</span><span class="n">ParamOut</span><span class="p">.</span><span class="n">GetParam</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetParam</span><span class="p">();</span>
</span><span class="line">        <span class="n">printf</span><span class="p">(</span><span class="err">“</span><span class="p">[</span><span class="n">Main</span><span class="p">]</span><span class="n">Sum</span> <span class="o">=</span> <span class="o">%</span><span class="n">s</span><span class="p">.</span><span class="o">/</span><span class="n">n</span><span class="err">”</span><span class="p">,</span> <span class="n">pData</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">getchar</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>好了，就这么点代码，改好了，我们再Build一下，然后点击运行。看看输出结果，是不是和以前的一样？ <br />
恩，是不是有点兴奋了？你成功的让Lua开始调用你的C++对象了！并且按照你要的方式执行！还记得我曾在第一篇文章里面许诺过，我会让你画出一个MFC窗体么？呵呵，如果你到现在依然觉得很清晰的话，说明你的距离已经不远了。</p>

<p>既然已经到了这里，我们索性再加点难度，如果我要把CTest作为一个对象返回回来怎么做？很简单，且看。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">        <span class="n">CLuaFn</span> <span class="n">LuaFn</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">InitClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">LoadLuaFile</span><span class="p">(</span><span class="err">“</span><span class="n">Sample</span><span class="p">.</span><span class="n">lua</span><span class="err">”</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">CParamGroup</span> <span class="n">ParamIn</span><span class="p">;</span>
</span><span class="line">        <span class="n">CParamGroup</span> <span class="n">ParamOut</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span> <span class="n">szData1</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">sprintf</span><span class="p">(</span><span class="n">szData1</span><span class="p">,</span> <span class="err">“</span><span class="p">[</span><span class="n">freeeyes</span><span class="p">]</span><span class="err">“</span><span class="p">);</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData1</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">szData1</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam1</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="kt">char</span> <span class="n">szData2</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="o">/</span><span class="mi">0</span><span class="err">′</span><span class="p">};</span>
</span><span class="line">        <span class="n">sprintf</span><span class="p">(</span><span class="n">szData2</span><span class="p">,</span> <span class="err">“</span><span class="p">[</span><span class="n">shiqiang</span><span class="p">]</span><span class="err">“</span><span class="p">);</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">szData2</span><span class="p">,</span> <span class="err">“</span><span class="n">string</span><span class="err">”</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">szData2</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam2</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CTest</span><span class="p">();</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">pTest</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CTest</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamIn</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam3</span><span class="p">);</span>
</span><span class="line">        <span class="n">CTest</span><span class="o">*</span> <span class="n">pTestRsult</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="line">        <span class="n">_ParamData</span><span class="o">*</span> <span class="n">pParam4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_ParamData</span><span class="p">(</span><span class="n">pTestRsult</span><span class="p">,</span> <span class="err">“</span><span class="n">CTest</span><span class="err">”</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pTestRsult</span><span class="p">));</span>
</span><span class="line">        <span class="n">ParamOut</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">pParam4</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="n">LuaFn</span><span class="p">.</span><span class="n">CallFileFn</span><span class="p">(</span><span class="err">“</span><span class="n">func_Add</span><span class="err">”</span><span class="p">,</span> <span class="n">ParamIn</span><span class="p">,</span> <span class="n">ParamOut</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">        <span class="c1">//接受Lua返回参数为CTest类型，并调用其中的方法。 </span>
</span><span class="line">        <span class="n">pTestRsult</span> <span class="o">=</span> <span class="p">(</span><span class="n">CTest</span><span class="o">*</span> <span class="p">)</span><span class="n">ParamOut</span><span class="p">.</span><span class="n">GetParam</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetParam</span><span class="p">();</span>
</span><span class="line">        <span class="n">pTestRsult</span><span class="o">-&gt;</span><span class="n">GetData</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="n">getchar</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>好，编译，执行。呵呵，看到了吧。</p>

<p>看到这里，如果你能看的明白，说明你已经对Lua如何调用C++接口，以及C++如何调用Lua有了一定的理解。当然，我写的这个类也不是很完善，不过做一半的Lua开发，应该是够用了。以以上的方式，你可以使用Lua驾驭你的C++代码。</p>

<p>好了，咱们既然已经说到这里了，再深一步，如果我的类是继承的，怎么办？呵呵，很好的问题。 <br />
比如，我的CTest继承了一个CBase，我的CBase又继承了一个。。。 <br />
在Lua里面，一样简单，我拿MFC的例子来举例吧，想必大家更喜欢看。 比如 CCmdTarget继承自CObject。 <br />
那么我在注册的时候可以这么写。</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="n">tolua_cclass</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span> <span class="err">“</span><span class="n">CCmdTarget</span><span class="err">”</span><span class="p">,</span>      <span class="err">”</span><span class="n">CCmdTarget</span><span class="err">”</span><span class="p">,</span>      <span class="err">”</span><span class="n">CObject</span><span class="err">”</span><span class="p">,</span>            <span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>这个表示CCmdTarget继承自CObject对象。 <br />
当然，MFC里面还会有很多类型，比如常数，Lua一样能处理。 <br />
举个例子说。</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="n">tolua_constant</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span> <span class="err">“</span><span class="n">ES_AUTOHSCROLL</span><span class="err">”</span><span class="p">,</span>   <span class="n">ES_AUTOHSCROLL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>这样注册，你就可以在 Lua里面使用ES_AUTOHSCROLL这个常数，它会自动绑定ES_AUTOHSCROLL这个C++常数对象。<br />
呵呵，说了这么多，让我们来点实际的。我给大家一个我以前写的MFC封装类（由于代码太多，我变成附件给大家），你们可以调用，当然，如果你有兴趣，就用我的MFC类，来做一个你喜欢的窗体吧，当然，你必须要用Lua脚本把它画出来，作为最后的考验，呵呵。</p>

<p><img src="/images/HelloLua_01_03.rar" alt="附带全部工程（附带Lua及tolua++）" /></p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-11-12T21:48:47+08:00" pubdate data-updated="true"></time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/c-plus-plus/'>c++</a>, <a class='category' href='/blog/categories/lua/'>lua</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<!-- JiaThis Button -->
	
	   <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2100653"></script>
<!-- UY END -->

	
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    newtomato

<br>
Powered by Octopress.

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259207383'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1259207383' type='text/javascript'%3E%3C/script%3E"));</script></footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-70121917-1');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



</body>
</html>
